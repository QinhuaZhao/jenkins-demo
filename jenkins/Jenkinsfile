pipeline {
  agent {
    kubernetes {
      yamlFile 'jenkins/JenkinsJnlpPod.yaml'
    }
  }
  environment{
    APP_NAME = readMavenPom().getArtifactId()

    REPO_NAMESPACE='qinhuazhao'
    IMAGE_NAME = "${APP_NAME}"
    BRANCH = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
    IMAGE_TAG = "${BRANCH + "-" + env.GIT_COMMIT}"

    DOMAIN = 'localhost'
  }
  stages {
    stage('pull code') {
      steps {
        container('git') {
          sh 'git clone https://github.com/QinhuaZhao/travel.git'
        }
      }
    }
    stage('Run maven') {
      steps {
        container('maven') {
          sh 'mvn package -B -DskipTests'
        }
      }
    }
    stage('Docker Build') {
        steps {
            container('docker') {
                sh "docker build -t ${REPO_NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }
    }
    stage('Helm Deploy') {
      steps {
        container('helm') {
          sh "helm template ${APP_NAME} ./helm --set name=${APP_NAME} --set image.repository=${REPO_NAMESPACE}/${IMAGE_NAME} --set image.tag=${IMAGE_TAG} --set domain=${DOMAIN} --set service.port=9090"
          sh "helm upgrade  ${APP_NAME} ./helm --install --force=false --set name=${APP_NAME} --set image.repository=${REPO_NAMESPACE}/${IMAGE_NAME} --set image.tag=${IMAGE_TAG} --set domain=${DOMAIN} --set service.port=9090"
        }
      }
    }
  }
}